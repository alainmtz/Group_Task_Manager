#!/bin/bash

# Script de diagn√≥stico para Cloud Functions

echo "üîç Diagn√≥stico de Cloud Functions"
echo "=================================="
echo ""

PROJECT="agenda-solar"

echo "1Ô∏è‚É£ Verificando tokens FCM en Firestore..."
echo ""
echo "Ejecuta este comando en Firebase Console o usa la SDK:"
echo ""
echo "Firestore ‚Üí users ‚Üí (selecciona un usuario) ‚Üí Busca campo 'fcmToken'"
echo ""
echo "Si no existe o est√° vac√≠o:"
echo "  - La app no est√° guardando el token"
echo "  - Verifica MyFirebaseMessagingService.kt"
echo "  - Verifica que onNewToken() se ejecute"
echo ""

echo "2Ô∏è‚É£ Verificando estado de la funci√≥n..."
firebase --project=$PROJECT functions:list 2>/dev/null | grep sendUpdateEvent || echo "‚ùå Funci√≥n no encontrada"
echo ""

echo "3Ô∏è‚É£ √öltimos errores:"
firebase --project=$PROJECT functions:log --only sendUpdateEvent --filter error --lines 5 2>/dev/null
echo ""

echo "4Ô∏è‚É£ Posibles causas del error 404 '/batch':"
echo ""
echo "   a) Tokens FCM inv√°lidos o mal formateados"
echo "   b) Problema con firebase-admin SDK"
echo "   c) Proyecto Firebase mal configurado"
echo "   d) API de FCM no habilitada"
echo ""

echo "5Ô∏è‚É£ Soluciones recomendadas:"
echo ""
echo "   Opci√≥n 1: Verificar tokens en Firestore"
echo "   --------"
echo "   1. Abre Firebase Console"
echo "   2. Ve a Firestore Database"
echo "   3. Collection 'users'"
echo "   4. Verifica que tengan campo 'fcmToken' con valor"
echo ""
echo "   Opci√≥n 2: Habilitar API de FCM"
echo "   --------"
echo "   1. https://console.cloud.google.com/apis/library/fcm.googleapis.com"
echo "   2. Selecciona proyecto: $PROJECT"
echo "   3. Clic en 'ENABLE'"
echo ""
echo "   Opci√≥n 3: Regenerar tokens en la app"
echo "   --------"
echo "   1. Desinstala la app del dispositivo"
echo "   2. Reinstala: ./gradlew installDebug"
echo "   3. Abre la app y login"
echo "   4. Verifica logs: adb logcat | grep FCM"
echo ""
echo "   Opci√≥n 4: Actualizar Cloud Function"
echo "   --------"
echo "   cd /home/alain/proyectos/kotlin/AgendaColaborativa"
echo "   firebase --project=$PROJECT deploy --only functions:sendUpdateEvent"
echo ""

echo "6Ô∏è‚É£ Ver logs en tiempo real:"
echo "   ./functions/monitor-logs.sh"
echo ""
