rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getCompanyData(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data;
    }
    
    function isCompanyOwner(companyId) {
      return isAuthenticated() && getCompanyData(companyId).ownerId == request.auth.uid;
    }
    
    function isCompanyAdmin(companyId) {
      let company = getCompanyData(companyId);
      return isAuthenticated() && (
        company.ownerId == request.auth.uid ||
        request.auth.uid in company.adminIds
      );
    }
    
    function isCompanyMember(companyId) {
      let company = getCompanyData(companyId);
      return isAuthenticated() && (
        company.ownerId == request.auth.uid ||
        request.auth.uid in company.adminIds ||
        request.auth.uid in company.memberIds
      );
    }

    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // ========================================
    // COMPANIES COLLECTION (NEW)
    // ========================================
    match /companies/{companyId} {
      // Anyone authenticated can read companies they belong to
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.adminIds ||
        request.auth.uid in resource.data.memberIds
      );
      
      // Only authenticated users can create their own company
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Only owner can update critical fields, admins can update some fields
      allow update: if isAuthenticated() && (
        // Owner can update everything
        resource.data.ownerId == request.auth.uid ||
        // Admins can update non-billing fields
        (request.auth.uid in resource.data.adminIds &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['planId', 'planTier', 'subscriptionStatus', 'googlePlayPurchaseToken']))
      );
      
      // Only owner can delete company
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // ========================================
    // PLANS COLLECTION (NEW - READ ONLY)
    // ========================================
    match /plans/{planId} {
      // Anyone authenticated can read plans
      allow read: if isAuthenticated();
      // No write access - plans managed by admin/cloud functions
      allow write: if false;
    }

    // ========================================
    // GROUPS COLLECTION
    // ========================================
    match /groups/{groupId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberIds;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        // Creator can always update
        resource.data.creatorId == request.auth.uid ||
        // Members can update if they are in the current member list
        request.auth.uid in resource.data.memberIds ||
        // Allow user to remove themselves even if not in the current list
        (request.auth.uid in resource.data.memberIds && 
         !(request.auth.uid in request.resource.data.memberIds))
      );
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }

    // ========================================
    // TASKS COLLECTION
    // ========================================
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        request.auth.uid in resource.data.assignedUserIds ||
        (resource.data.groupId != null && request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.groupId)).data.memberIds)
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        request.auth.uid in resource.data.assignedUserIds
      );
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }

    // ========================================
    // SUBTASKS COLLECTION
    // ========================================
    match /subtasks/{subtaskId} {
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        request.auth.uid in resource.data.assignedUserIds ||
        get(/databases/$(database)/documents/tasks/$(resource.data.parentTaskId)).data.creatorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        request.auth.uid in resource.data.assignedUserIds ||
        get(/databases/$(database)/documents/tasks/$(resource.data.parentTaskId)).data.creatorId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // ========================================
    // EARNINGS COLLECTION
    // ========================================
    match /earnings/{earningId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.creatorId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
      allow delete: if false; // Earnings should not be deleted
    }

    // ========================================
    // CHAT THREADS COLLECTION
    // ========================================
    match /chatThreads/{threadId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberIds;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.memberIds ||
        // Allow users to remove themselves even if already removed from group
        (request.auth.uid in resource.data.memberIds && 
         !(request.auth.uid in request.resource.data.memberIds))
      );
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.memberIds;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chatThreads/$(threadId)).data.memberIds;
        allow create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chatThreads/$(threadId)).data.memberIds;
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chatThreads/$(threadId)).data.memberIds;
      }
    }

    // ========================================
    // NOTIFICATIONS COLLECTION
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // BIDS COLLECTION
    // ========================================
    match /bids/{bidId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ========================================
    // AUDIT LOGS COLLECTION (Enterprise only)
    // ========================================
    match /auditLogs/{logId} {
      // Only company admins can read audit logs for their company
      allow read: if isAuthenticated() && (
        // Check if user is admin of any company (could be enhanced to check specific company)
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserData().role == 'admin'
      );
      
      // Writes are handled by the application layer (authenticated users)
      // In production, consider using a Cloud Function with service account
      allow create: if isAuthenticated();
      
      // No updates or deletes - audit logs are immutable
      allow update: if false;
      allow delete: if false;
    }
  }
}
